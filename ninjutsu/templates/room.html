{% extends "_base.html" %}
{% block content %}
<script src="https://unpkg.com/vue@3"></script>
<script type="text/javascript">
    window.room_uuid = "{{ room_uuid }}"
    const audioVolume = 0.3;
    function newAudio(url, volume) {
        const audio = new Audio(url);
        audio.volume = volume ? volume : audioVolume;
        return audio;
    }
    const ninjaScreamAudio = [
        newAudio('/static/audio/202037__thestigmata__man-die.mp3'),
        newAudio('/static/audio/369593__eflexmusic__hard-punch-to-gut-indoor-large-room.mp3'),
        newAudio('/static/audio/44267__erdie__male-fight07.mp3'),
        newAudio('/static/audio/442288__rockittt__male-pain-sound-effects-A.mp3'),
        newAudio('/static/audio/442288__rockittt__male-pain-sound-effects-B.mp3'),
        newAudio('/static/audio/442288__rockittt__male-pain-sound-effects-C.mp3'),
    ]
    const swordSliceAudio = [
        newAudio('/static/audio/344131__thebuilder15__sword-slice.mp3'),
        newAudio('/static/audio/591155__ultraaxvii__sword-contact-with-swipe.mp3'),
        newAudio('/static/audio/462983__bastianhallo__knife-being-sharpened.mp3'),
        newAudio('/static/audio/504615__neospica__slicing-through-flesh.mp3'),
    ]
</script>

{% raw %}
<div id="app" style="text-align: center;">
    <div class="results">
        <div class="vote" v-for="vote in votes">
            <p v-if="vote.value && status == 'PROGRESS'">X</p>
            <p v-if="vote.value && status == 'RESULT'">{{ vote.value }}</p>
            <p v-if="!vote.value">-</p>
        </div>
    </div>
    <div class="options">
        <button v-on:click="vote(1)">1</button>
        <button v-on:click="vote(2)">2</button>
        <button v-on:click="vote(3)">3</button>
        <button v-on:click="vote(5)">5</button>
        <button v-on:click="vote(8)">8</button>
    </div>
    <div class="controls">
        <button v-if="status == 'RESULT'" v-on:click="reset()">reset</button>
    </div>
</div>


<script>
// Vue app
Vue.createApp({
  data() {
    const data = {
      message: 'Hello Vue!' + window.room_uuid,
      test: this.test,
      playerId: this.playerId,
      status: this.status,
      votes: this.votes,
    }
    return data;
  },

  mounted() {
    const that = this;
    // The websocket
    this.socket = new WebSocket("ws://"+window.location.host+window.location.pathname+'/ws')
    // Listen for messages
    this.socket.addEventListener('message', function (event) {
        // Parse event
        const parts = event.data.split(" ");
        const evName = parts[0]

        switch(evName) {
            case "WELCOME":
                that.playerId = parseInt(parts[1])
                break;
            case "VOTE":
                // Sword slice!
                const sound = swordSliceAudio[Math.floor(Math.random() * swordSliceAudio.length)];
                sound.pause();
                sound.currentTime = 0;
                sound.play()
                break;
            case "ROOM_STATE":
                const status = parts[1]

                switch(status) {
                    case "PROGRESS":
                        that.status = status
                        that.votes = parts.slice(2).map(user => {
                            const parts = user.split(":")
                            return {
                                userId: parseInt(parts[0]),
                                value: parts[1].toLowerCase() == "true",
                            }
                        })
                        break;
                    case "RESULT":
                        if (that.status != "RESULT") {
                            // Hai!
                            const sound = ninjaScreamAudio[Math.floor(Math.random() * ninjaScreamAudio.length)];
                            sound.pause();
                            sound.currentTime = 0;
                            sound.play()
                        }
                        that.status = status
                        that.votes = parts.slice(2).map(user => {
                            const parts = user.split(":")
                            return {
                                userId: parseInt(parts[0]),
                                value: parseInt(parts[1]),
                            }
                        })
                        break;
                }
                break;
        }

        console.log('Message from server ', event.data);
    });
    this.test = "test";
  },

  unmounted() {
    this.socket.close()
  },

  methods: {
    vote(value) {
      this.socket.send("VOTE "+value)
    },
    reset(value) {
      this.socket.send("RESET")
    }
  }

}).mount('#app')
</script>
{% endraw %}
{% endblock %}
